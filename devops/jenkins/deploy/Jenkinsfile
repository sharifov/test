pipeline {
  agent any
  options {
    ansiColor('xterm')
    disableConcurrentBuilds()
    withAWS(credentials: "aws-${ENV}")
  }
  stages {
    stage('Build') {
      steps {
        sshagent(credentials: ['git-crm']) {
          sh 'composer install --no-interaction --ignore-platform-reqs'
        }
        sh '''
          tar --exclude=./devops --exclude=./.git \
            -czf devops/ansible/roles/deployment/files/build.tar.gz .
        '''
      }
    }
    stage('Deploy') {
      steps {
        dir('devops/ansible') {
          ansiblePlaybook(
            playbook: 'deploy.yml',
            inventory: "inventories/${ENV}/aws_ec2.yml",
            credentialsId: "ssh-${ENV}",
            vaultCredentialsId: "vault-${ENV}",
            extraVars: [ app_ver: "${GIT_COMMIT[0..6]}" ]
          )
        }
      }
    }
  }
  post {
    success {
      script {
        if (env.ENV == 'prod') {
          office365ConnectorSend(
            color: '#00ff00',
            message: "${currentBuild.getBuildCauses()[0].shortDescription}",
            factDefinitions: [
              [ name: "Status", template: "${currentBuild.result}"],
              [ name: "Build", template: "[${env.BUILD_NUMBER}](${env.BUILD_URL}display/redirect)"],
              [ name: "Env", template: "${env.ENV}"],
              [ name: "Branch", template: "${GIT_BRANCH.replaceFirst(/^.*\//, '')}"],
              [ name: "Version", template: "${GIT_COMMIT[0..6]}"],
              [ name: "Time", template: "${currentBuild.durationString.minus(' and counting')}"]
            ],
            webhookUrl: 'https://kivdev.webhook.office.com/webhookb2/821ecf73-6ea0-447a-acc9-033615a3af1e@7e49a909-af00-4220-a5f9-ba8c5979078f/JenkinsCI/6b0a3c740e4a44548bf47708b2ab1562/5852b332-1191-4d8c-a325-d4d3e50904c6'
          )
        }
      }
      office365ConnectorSend(
        color: '#00ff00',
        message: "${currentBuild.getBuildCauses()[0].shortDescription}",
        factDefinitions: [
          [ name: "Status", template: "${currentBuild.result}"],
          [ name: "Build", template: "[${env.BUILD_NUMBER}](${env.BUILD_URL}display/redirect)"],
          [ name: "Env", template: "${env.ENV}"],
          [ name: "Branch", template: "${GIT_BRANCH.replaceFirst(/^.*\//, '')}"],
          [ name: "Version", template: "${GIT_COMMIT[0..6]}"],
          [ name: "Time", template: "${currentBuild.durationString.minus(' and counting')}"]
        ],
        webhookUrl: 'https://kivdev.webhook.office.com/webhookb2/821ecf73-6ea0-447a-acc9-033615a3af1e@7e49a909-af00-4220-a5f9-ba8c5979078f/JenkinsCI/16048d8f33194886840802182fd7cb74/5852b332-1191-4d8c-a325-d4d3e50904c6'
      )
    }
    failure {
      office365ConnectorSend(
        color: '#ff0000',
        message: "${currentBuild.getBuildCauses()[0].shortDescription}",
        factDefinitions: [
          [ name: "Status", template: "${currentBuild.result}"],
          [ name: "Build", template: "[${env.BUILD_NUMBER}](${env.BUILD_URL}display/redirect)"],
          [ name: "Env", template: "${env.ENV}"],
          [ name: "Branch", template: "${GIT_BRANCH.replaceFirst(/^.*\//, '')}"],
          [ name: "Version", template: "${GIT_COMMIT[0..6]}"],
          [ name: "Time", template: "${currentBuild.durationString.minus(' and counting')}"]
        ],
        webhookUrl: 'https://kivdev.webhook.office.com/webhookb2/821ecf73-6ea0-447a-acc9-033615a3af1e@7e49a909-af00-4220-a5f9-ba8c5979078f/JenkinsCI/16048d8f33194886840802182fd7cb74/5852b332-1191-4d8c-a325-d4d3e50904c6'
      )
    }
    always {
      cleanWs()
    }
  }
}
