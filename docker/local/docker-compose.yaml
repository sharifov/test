version: '3.9'

services:
  redis:
    build:
      context: ./redis
      args:
        REDIS_VERSION: ${REDIS_VERSION}
    restart: always
    ports:
      - ${REDIS_HOST_PORT}:6379

  mysql:
    build:
      context: ./mysql
      args:
        MYSQL_VERSION: ${MYSQL_VERSION}
    volumes:
      - ${MYSQL_HOST_PATH_DB}:/var/lib/mysql
      - ${MYSQL_HOST_PATH_DUMP}:/docker-entrypoint-initdb.d
    ports:
      - ${MYSQL_HOST_PORT}:3306
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    restart: always

  psql:
    build:
      context: ./psql
      args:
        POSTGRES_VERSION: ${POSTGRES_VERSION}
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ${POSTGRES_HOST_PATH_DB}:/var/lib/postgresql/data
      - ${POSTGRES_HOST_PATH_DUMP}:/dump
      - ${POSTGRES_HOST_PATH_DUMP}:/docker-entrypoint-initdb.d
    ports:
      - ${POSTGRES_HOST_PORT}:5432
    restart: always

  centrifugo:
    image: centrifugo/centrifugo:${CENTRIFUGO_VERSION}
    volumes:
      - ${CENTRIFUGO_CONFIG_PATH}:/centrifugo/config.json
    command: centrifugo -c config.json
    ports:
      - ${CENTRIFUGO_HOST_PORT}:8000
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    networks:
      default:
        aliases:
          - centrifugo
    restart: always

  beanstalkd:
    build:
      context: ./beanstalkd
      args:
        version: ${BEANSTALKD_VERSION}
    restart: always
    ports:
      - ${BEANSTALKD_PORT}

  frontend:
    build:
      context: ./frontend
      args:
        REGISTRY: ${REGISTRY}
        IMAGE_TAG: ${IMAGE_TAG}
    volumes:
      - ${APP_PATH}:${APP_PATH}
    working_dir: ${APP_PATH}
    depends_on:
     - mysql
     - psql
     - redis
     - beanstalkd
     - centrifugo
     - queue
    restart: always

  api:
    build:
      context: ./api
      args:
        REGISTRY: ${REGISTRY}
        IMAGE_TAG: ${IMAGE_TAG}
    volumes:
      - ${APP_PATH}:${APP_PATH}
    working_dir: ${APP_PATH}
    depends_on:
     - mysql
     - psql
     - redis
     - beanstalkd
     - centrifugo
     - queue
    restart: always

  nginx:
    build:
      context: ./nginx
      args:
        NGINX_VERSION: ${NGINX_VERSION}
    volumes:
      - ${LOGS_PATH}:${LOGS_PATH}
      - ${LOGS_PATH}:/var/log/nginx
      - ${SSL_PATH}:${SSL_PATH}
      - ${FILE_STORAGE_PATH}:${FILE_STORAGE_PATH}
      - ${APP_PATH}:${APP_PATH}
    ports:
      - ${HOST_PORT}:${HOST_PORT} #frontend
      - ${HOST_API_PORT}:${HOST_API_PORT} #api
    depends_on:
      - frontend
      - api
    restart: always
    environment:
      - NGINX_ENVSUBST_TEMPLATE_DIR=${NGINX_TEMPLATE_PATH}
      - APP_PATH=${APP_PATH}
      - LOGS_PATH=${LOGS_PATH}
      - FILE_STORAGE_PATH=${FILE_STORAGE_PATH}
      - HOST=${HOST}
      - HOST_PORT=${HOST_PORT}
      - HOST_API=${HOST_API}
      - HOST_API_PORT=${HOST_API_PORT}
      - SSL_CRT_PATH=${SSL_CRT_PATH}
      - SSL_KEY_PATH=${SSL_KEY_PATH}
      - WEB_SOCKET_SERVER_PORT=${WEB_SOCKET_SERVER_PORT}

  ws:
    build:
      context: ./ws
      args:
        REGISTRY: ${REGISTRY}
        IMAGE_TAG: ${IMAGE_TAG}
    volumes:
      - ${APP_PATH}:${APP_PATH}
    working_dir: ${APP_PATH}
    depends_on:
      - mysql
      - psql
      - redis
      - beanstalkd
    restart: always
    command: ./yii websocket-server/start

  queue:
    build:
      context: ./queue
      args:
        APP_PATH: ${APP_PATH}
        REGISTRY: ${REGISTRY}
        IMAGE_TAG: ${IMAGE_TAG}
    volumes:
      - ${APP_PATH}:${APP_PATH}
    working_dir: ${APP_PATH}
    depends_on:
      - mysql
      - psql
      - beanstalkd
      - centrifugo
      - redis
    restart: always

  console:
    build:
      context: ./console
      args:
        REGISTRY: ${REGISTRY}
        IMAGE_TAG: ${IMAGE_TAG}
    user: ${USER_ID}:${USER_GID}
    volumes:
      - ${APP_PATH}:${APP_PATH}
    working_dir: ${APP_PATH}
    depends_on:
      - mysql
      - psql
      - beanstalkd
      - redis